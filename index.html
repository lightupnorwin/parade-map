<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Light Up Norwin Parade Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css">

<style>
html,body{height:100%;margin:0;overflow:hidden;}
#map{height:100%;width:100%;position:absolute;top:0;left:0;z-index:1;}
:root{--brand:#1756ff;--bg:#fff;--ink:#111;--muted:#666;--panel-bg:linear-gradient(180deg,#fff 0%,#f8f9fb 100%);}
body{background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;}
.top-nav{position:fixed;top:0;left:0;width:100%;height:70px;background:var(--panel-bg);
display:flex;justify-content:space-around;align-items:center;box-shadow:0 2px 8px rgba(0,0,0,0.15);
border-bottom:1px solid #ddd;z-index:15;padding-top:env(safe-area-inset-top,0);}
.nav-item{flex:1;text-align:center;cursor:pointer;font-weight:600;color:#555;transition:color .2s;}
.nav-item span{display:block;font-size:22px;margin-bottom:2px;}
.nav-item.active{color:var(--brand);}
.map-actions{position:absolute;top:90px;right:20px;display:flex;flex-direction:column;gap:8px;z-index:12;}
.map-actions button{background:#fff;border:none;border-radius:50%;width:46px;height:46px;font-size:22px;cursor:pointer;
box-shadow:0 2px 8px rgba(0,0,0,0.3);transition:transform .15s ease;}
.map-actions button:active{transform:scale(0.95);}
.route-actions{position:absolute;top:90px;left:20px;z-index:12;display:none;}
.route-actions .cancel{background:#fff;border:none;border-radius:999px;padding:10px 14px;font-weight:700;
box-shadow:0 2px 8px rgba(0,0,0,.3);cursor:pointer;}
.route-actions.show{display:block;}

/* --- Panels --- */
.view {
  position: fixed;
  left: 50%;
  bottom: 0;
  transform: translate(-50%, 100%);
  width: 92%;
  max-width: 640px;
  background: var(--panel-bg);
  border-top-left-radius: 16px;
  border-top-right-radius: 16px;
  box-shadow: 0 -3px 15px rgba(0,0,0,0.25);
  display: flex;
  flex-direction: column;
  max-height: 70vh;
  overflow: hidden;
  transition: transform 0.35s ease;
  z-index: 10;
  backdrop-filter: blur(8px);
  pointer-events: none;
  visibility: hidden;
}
.view.active {
  transform: translate(-50%, 0);
  pointer-events: auto;
  visibility: visible;
  z-index: 20;
}

/* Sticky header inside panels */
.view-header {
  position: sticky;
  top: 0;
  background: var(--panel-bg);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px 10px 20px;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  z-index: 25;
}
.view-header h1 {
  margin: 0;
  font-size: 20px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 8px;
}
.close-btn {
  border: none;
  background: rgba(255, 255, 255, 0.95);
  color: #000;
  font-size: 20px;
  font-weight: bold;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  flex-shrink: 0;
}
.close-btn:active { transform: scale(0.95); }
.scroll-inner { flex: 1; overflow-y: auto; padding: 10px 20px 90px; }

.card{background:transparent;}
.row{padding:10px 0;border-top:1px solid rgba(0,0,0,0.1);}
.row:first-child{border-top:none;}
.btn{background:var(--brand);color:#fff;padding:6px 10px;border:none;border-radius:8px;cursor:pointer;font-weight:600;}
.btn:active{transform:scale(0.97);}
.btn.secondary{background:#e9ecf7;color:#122;}
.badge{display:inline-block;background:#eef3ff;color:#245;font-weight:700;border-radius:999px;
padding:2px 8px;margin-left:6px;font-size:12px;}
.btn-row{display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end;margin-top:6px;}
@media(max-width:480px){.btn-row{flex-direction:column;align-items:stretch}.btn-row .btn{width:100%}}
.overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.25);
opacity:0;visibility:hidden;transition:opacity .25s;z-index:5;}
.overlay.active{opacity:1;visibility:visible;}
.search-tray{position:fixed;top:70px;left:0;width:100%;background:#fff;border-bottom:1px solid #ddd;z-index:14;
transform:translateY(-110%);transition:transform .25s ease;box-shadow:0 2px 10px rgba(0,0,0,0.1);}
.search-tray.active{transform:translateY(0);}
.search-inner{padding:10px 12px 14px;}
.search-bar{display:flex;gap:8px;}
.search-input{flex:1;border:1px solid #ddd;border-radius:12px;padding:10px 12px;font-size:16px;outline:none;}
.search-results{max-height:50vh;overflow:auto;margin-top:8px;}
.result{padding:10px;border-top:1px solid #eee;}
.result-title{font-weight:700;}
.result-meta{color:#666;font-size:13px;margin:2px 0 6px;}
.leaflet-routing-container{display:none;}
</style>
</head>

<body>
<div id="map"></div>
<div class="overlay" id="overlay"></div>
<div class="map-actions"><button id="locateMe" title="Use my location">üìç</button></div>
<div class="route-actions" id="routeActions"><button class="cancel" id="cancelRoute">Cancel Directions</button></div>

<!-- Panels -->
<div id="view-schedule" class="view">
  <div class="view-header">
    <h1>üìÖ Schedule</h1>
    <button class="close-btn" onclick="hidePanels()">‚úï</button>
  </div>
  <div class="scroll-inner">
    <div class="card" id="scheduleList">
      <div class="row" data-time="2025-11-20T17:00:00-05:00" data-target="Main Street Stage"><strong>5:00 PM</strong> ‚Äì East End Kids<span class="badge">Event</span></div>
      <div class="row" data-time="2025-11-20T17:30:00-05:00" data-target="Main Street Stage"><strong>5:30 PM</strong> ‚Äì Main Street Music Students<span class="badge">Event</span></div>
      <div class="row" data-time="2025-11-20T18:00:00-05:00" data-target="Main Street Stage"><strong>6:00 PM</strong> ‚Äì CP Music<span class="badge">Event</span></div>
      <div class="row" data-time="2025-11-20T18:30:00-05:00" data-target="Tree Lighting"><strong>6:30 PM</strong> ‚Äì Parade Begins! <em>(Rick Sebak of WQED serves as MC)</em><span class="badge">Parade</span></div>
    </div>
  </div>
</div>

<div id="view-vendors" class="view">
  <div class="view-header">
    <h1>üçî Food & Shopping</h1>
    <button class="close-btn" onclick="hidePanels()">‚úï</button>
  </div>
  <div class="scroll-inner">
    <div class="card" id="vendorList"></div>
  </div>
</div>

<div id="view-restrooms" class="view">
  <div class="view-header">
    <h1>üöª Restrooms</h1>
    <button class="close-btn" onclick="hidePanels()">‚úï</button>
  </div>
  <div class="scroll-inner">
    <div class="card">
      <div class="row"><div>415 Main St (Public)<span class="badge">Restroom</span></div>
        <div class="btn-row">
          <button class="btn" onclick="focusLocation('Restrooms')">Show on Map</button>
          <button class="btn secondary" onclick="routeToByName('Restrooms')">Get Directions</button>
        </div>
      </div>
      <div class="row"><div>Portable Units ‚Äî S&amp;T Bank Plaza<span class="badge">Restroom</span></div>
        <div class="btn-row">
          <button class="btn" onclick="focusLocation('Tree Lighting')">Show on Map</button>
          <button class="btn secondary" onclick="routeToByName('Tree Lighting')">Get Directions</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Top Nav -->
<nav class="top-nav">
  <div class="nav-item" data-view="schedule"><span>üìÖ</span>Schedule</div>
  <div class="nav-item" data-view="vendors"><span>üçî</span>Vendors</div>
  <div class="nav-item" data-view="restrooms"><span>üöª</span>Restrooms</div>
  <div class="nav-item" data-view="search"><span>üîé</span>Search</div>
</nav>

<!-- Search tray -->
<div class="search-tray" id="searchTray">
  <div class="search-inner">
    <div class="search-bar">
      <input id="searchInput" class="search-input" type="text" placeholder="Search vendors, restrooms, events‚Ä¶" autofocus>
      <button id="searchClear" class="btn secondary" type="button">Clear</button>
    </div>
    <div id="searchResults" class="search-results"></div>
  </div>
</div>

<!-- JS imports -->

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script>
const map=L.map('map',{zoomControl:true}).setView([40.332,-79.7105],18);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:20}).addTo(map);
const colors={Restrooms:"#007aff",Events:"#ff3b30",Food:"#34c759",Shopping:"#af52de"};
function makeIcon(e,c){const s=encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40'><circle cx='20' cy='20' r='18' fill='${c}'/><text x='50%' y='55%' font-size='18' text-anchor='middle' fill='white'>${e}</text></svg>`);return L.icon({iconUrl:"data:image/svg+xml,"+s,iconSize:[30,30],iconAnchor:[15,30],popupAnchor:[0,-28]});}
const icons={Restrooms:makeIcon("üöª",colors.Restrooms),Events:makeIcon("üéÑ",colors.Events),Food:makeIcon("üçî",colors.Food),Shopping:makeIcon("üõçÔ∏è",colors.Shopping)};
const basePins=[
{position:[40.3314911,-79.710878],name:"Restrooms",description:"Public restrooms at 415 Main St.",category:"Restrooms"},
{position:[40.332795,-79.710338],name:"Tree Lighting",description:"S&T Bank Plaza.",category:"Events"},
{position:[40.332008,-79.711068],name:"Main Street Stage",description:"Live performances all evening.",category:"Events"},
{position:[40.331993,-79.710851],name:"Food Vendor",description:"Serving warm treats all evening.",category:"Food"},
{position:[40.332086,-79.710864],name:"Craft Vendor",description:"Handmade holiday crafts.",category:"Shopping"}
];
const markers=[];
basePins.forEach(l=>{
const popup=`<b>${l.name}</b><br>${l.description}<br>
<div class='btn-row'><button class='btn secondary' onclick="routeToByName('${l.name}')">Get Directions</button>
${l.name==="Main Street Stage"?"<button class='btn' onclick=\"togglePanel('schedule')\">Show Schedule</button>":""}</div>`;
const m=L.marker(l.position,{icon:icons[l.category]}).bindPopup(popup).addTo(map);
m.name=l.name;m.category=l.category;m._desc=l.description;m._hasCoords=true;markers.push(m);});
map.fitBounds(L.featureGroup(markers).getBounds(),{padding:[40,40]});
function focusLocation(n){const m=markers.find(x=>x.name===n);if(m){hidePanels();map.setView(m.getLatLng(),19);m.openPopup();}}
document.getElementById("locateMe").onclick=()=>navigator.geolocation?.getCurrentPosition(p=>{map.setView([p.coords.latitude,p.coords.longitude],18);L.circleMarker([p.coords.latitude,p.coords.longitude],{radius:8,color:"#1756ff",fillOpacity:.9}).addTo(map).bindPopup("You are here").openPopup();});
const navItems=document.querySelectorAll('.nav-item'),panels=document.querySelectorAll('.view'),
overlay=document.getElementById('overlay'),searchTray=document.getElementById('searchTray');let current=null;
function hidePanels(){panels.forEach(v=>v.classList.remove('active'));navItems.forEach(n=>n.classList.remove('active'));
overlay.classList.remove('active');searchTray.classList.remove('active');current=null;}
function togglePanel(v){if(v==='search'){const o=searchTray.classList.contains('active');hidePanels();
if(!o){rebuildSearchIndex();searchTray.classList.add('active');document.querySelector('.nav-item[data-view="search"]').classList.add('active');
overlay.classList.add('active');setTimeout(()=>document.getElementById('searchInput').focus(),50);current='search';}return;}
if(current===v){hidePanels();return;}hidePanels();document.getElementById('view-'+v).classList.add('active');
document.querySelector(`.nav-item[data-view="${v}"]`).classList.add('active');overlay.classList.add('active');current=v;}
overlay.onclick=hidePanels;map.on('click',hidePanels);
navItems.forEach(i=>i.addEventListener('click',()=>togglePanel(i.dataset.view)));
function updateSchedule(){const n=new Date(),r=document.querySelectorAll('#scheduleList .row');let a=null,s=1/0;
r.forEach(e=>{const t=new Date(e.dataset.time),d=(t-n)/6e4;if(n<new Date("2025-11-20T00:00:00-05:00")){e.style.display="block";e.classList.remove('faded','active-now');return;}
if(d<-15)e.style.display="none";else if(d<0)e.classList.add('faded');else{e.classList.remove('faded');e.style.display="block";if(d<s){s=d;a=e;}}});
r.forEach(e=>e.classList.remove('active-now'));if(a)a.classList.add('active-now');}
updateSchedule();setInterval(updateSchedule,6e4);

/* Vendors */
const vendorsData=[
{name:"WPF Concessions",cat:"Food",desc:"Wings, bites, pizza muffins, fries, nachos, soda & water."},
{name:"High On The Hog",cat:"Food",desc:"BBQ favorites."},
{name:"Truckin Triangles",cat:"Food",desc:"Stuffed triangles with assorted meats."},
{name:"Hermesfoodtrucks",cat:"Food",desc:"Gyros, burgers, tenders, fries, cheesesticks, baklava, fried Oreos."},
{name:"PGH Crepes",cat:"Food",desc:"Cr√™pes, fries & lemonade."},
{name:"Millie‚Äôs Homemade Ice Cream",cat:"Food",desc:"Ice cream treats."},
{name:"Travelin' Tom‚Äôs Coffee Truck",cat:"Food",desc:"Espresso, chai, hot chocolate, refreshers."},
{name:"Mutiny Donuts",cat:"Food",desc:"Fresh donuts made on site."},
{name:"Fox‚Äôs Pizza North Huntingdon",cat:"Food",desc:"Pizza, drinks, cookies, light-up toys."},
{name:"The Rustic Roamer LLC",cat:"Food",desc:"Specialty coffee & baked goods."},
{name:"Court Yard Concessions",cat:"Food",desc:"Funnel cakes, fried Oreos, corn dogs, pretzels."},
{name:"carmine‚Äôs pizza neapolitana",cat:"Food",desc:"Artisan pizza by the slice & whole."},
{name:"Live Casino",cat:"Shopping",desc:"Promo items & literature."},
{name:"A & A Novelties LLC",cat:"Shopping",desc:"Light-up toys & Christmas novelties."},
{name:"Tie Dyed By Aimee",cat:"Shopping",desc:"Tie-dyed apparel."},
{name:"Cami‚Äôs Dreamland",cat:"Shopping",desc:"Whimsical decor, crystals, vintage clothing."},
{name:"Window Nation",cat:"Shopping",desc:"Window & door info."},
{name:"Tangled in Crafts by Ashley",cat:"Shopping",desc:"Bleached tees & sweatshirts, on-site press."},
{name:"Bright Light Candles",cat:"Shopping",desc:"Candles, wax melts, sprays & more."},
{name:"Norwin Mini-Thon",cat:"Shopping",desc:"Hot cocoa, face painting & merch."},
{name:"Calvin Presbyterian Church",cat:"Shopping",desc:"Free kids‚Äô crafts & glow bracelets."},
{name:"hype and harmony",cat:"Shopping",desc:"Jewelry & clothing."},
{name:"FYZICAL Therapy & Balance",cat:"Shopping",desc:"STOPAIN sales & therapy info."},
{name:"Pretend Food Vendor",cat:"Food",desc:"Demo vendor for testing."},
{name:"Pretend Craft Vendor",cat:"Shopping",desc:"Demo craft vendor for testing."}
];
function buildVendorsList(){const l=document.getElementById('vendorList');
const f=vendorsData.filter(v=>v.cat==="Food"),s=vendorsData.filter(v=>v.cat!=="Food");
const mk=v=>`<div class='row'><div>${v.name}<span class='badge'>${v.cat}</span><br><small>${v.desc}</small></div>
<div class='btn-row'><button class='btn' onclick="alert('Location pin coming soon.')">Show on Map</button>
<button class='btn secondary' onclick="alert('Directions available soon.')">Get Directions</button></div></div>`;
l.innerHTML=`<h3>Food Vendors</h3>${f.map(mk).join('')}<h3 style='margin-top:14px;'>Shopping & Activities</h3>${s.map(mk).join('')}`;}
buildVendorsList();

/* Search */
const searchInput=document.getElementById('searchInput'),searchResults=document.getElementById('searchResults');
document.getElementById('searchClear').onclick=()=>{searchInput.value='';renderResults([]);searchInput.focus();};
let allData=[];
function rebuildSearchIndex(){
const loc=markers.map(m=>({type:m.category,title:m.name,description:m._desc,target:m.name}));
const sched=[...document.querySelectorAll('#scheduleList .row')].map(e=>({type:'Event',title:e.innerText,description:e.innerText,target:e.dataset.target||''}));
const vend=vendorsData.map(v=>({type:v.cat,title:v.name,description:v.desc,target:v.name}));
allData=[...loc,...vend,...sched];
}
function highlight(t,q){if(!q)return t;return t.replace(new RegExp(`(${q})`,'gi'),'<mark>$1</mark>');}
function renderResults(a,q=''){if(!a.length){searchResults.innerHTML='<div class=result>No results found.</div>';return;}
searchResults.innerHTML=a.map(i=>`<div class=result><div class=result-title>${highlight(i.title,q)}</div>
<div class=result-meta>${i.type} ‚Äî ${highlight(i.description,q)}</div>
<div class=btn-row><button class=btn onclick="alert('Location pin coming soon.')">Show on Map</button>
<button class='btn secondary' onclick="alert('Directions available soon.')">Get Directions</button></div></div>`).join('');}
searchInput.addEventListener('input',()=>{const q=searchInput.value.trim().toLowerCase();if(!q){renderResults([]);return;}
const terms=q.split(/\s+/);const r=allData.filter(i=>{const h=(i.title+' '+i.description+' '+i.type).toLowerCase();
return terms.every(t=>h.includes(t));});renderResults(r.slice(0,100),q);});

/* Routing */
let routeControl=null,userMarker=null,watchId=null,destLatLng=null;
function routeToByName(n){const m=markers.find(x=>x.name===n);if(m)startRoutingTo(m.getLatLng());}
function startRoutingTo(l){destLatLng=L.latLng(l);
if(!navigator.geolocation){alert('Geolocation not supported');return;}
if(!routeControl){routeControl=L.Routing.control({waypoints:[],addWaypoints:false,draggableWaypoints:false,fitSelectedRoutes:true,show:false,
router:L.Routing.osrmv1({serviceUrl:'https://router.project-osrm.org/route/v1',profile:'foot'}),
lineOptions:{styles:[{color:'#2E6CF6',weight:6,opacity:.9}]}}).addTo(map);}
clearWatch();watchId=navigator.geolocation.watchPosition(p=>{const h=L.latLng(p.coords.latitude,p.coords.longitude);
if(!userMarker){userMarker=L.circleMarker(h,{radius:8,color:"#1756ff",fillOpacity:.9}).addTo(map);}else{userMarker.setLatLng(h);}
routeControl.setWaypoints([h,destLatLng]);document.getElementById('routeActions').classList.add('show');
const d=map.distance(h,destLatLng);if(d<=50){fadeOutRouteThenEnd();}});}
function fadeOutRouteThenEnd(){const l=routeControl&&routeControl._line?routeControl._line:null;
if(l&&l.setStyle){let o=.9;const f=setInterval(()=>{o-=.18;if(o<=0){clearInterval(f);endRouting();}else{l.setStyle({opacity:o});}},120);}else endRouting();}
function endRouting(){clearWatch();if(routeControl){try{routeControl.setWaypoints([]);}catch(e){}}
if(userMarker){map.removeLayer(userMarker);userMarker=null;}destLatLng=null;document.getElementById('routeActions').classList.remove('show');}
function clearWatch(){if(watchId!==null){navigator.geolocation.clearWatch(watchId);watchId=null;}}
document.getElementById('cancelRoute').onclick=endRouting;
</script>
</body>
</html>
